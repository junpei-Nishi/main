# Readme

ここでは、カメラで撮影した画像をディープラーニングによって良品か不良品かを検査する方法について解説します。

検査方法の流れは大きく3つあります。

1. 学習に必要な画像をカメラで撮影する ▶ データセットの作成
2. 撮影した画像を用いて学習する ▶ 学習
3. 学習データを用いて検査する ▶ 推論

ステップ1～2までは、推論を行うための準備作業となりますので、通常は1度だけ行えば問題ありません。  
作業自体はとても簡単ですので、さまざまな条件で学習してみて、結果がどう変化するかを体験してください。

## 1. データセットを作成する

まず、学習に必要なデータセットを作成します。  
データセットとは、学習に使用する画像をひとまとめにしたものを指します。

次のコマンドをターミナル上で実行することで、カメラ映像のプレビュー画面が表示されます。  
その画面上でキーボード操作を行うことで、「学習用の良品画像」、「評価用の良品画像」、「評価用の不良品画像」を撮影して画像保存することができます。  

「学習用の良品画像」は、より精度の高い学習を行うために 100枚以上 ご用意いただくことをお勧めします。  
「評価用の良品/不良品画像」は、10枚以上 を目安にしてください。

### データセット作成用スクリプト `make_dataset.py` の使用方法

#### コマンド実行方法

ターミナル上で、次のようなコマンドを実行してデータセットを作成してください。  
コマンドの引数について詳しくは、下図「引数一覧」を参照してください。

```sh
$ python make_dataset.py -n aluminum_cubic_20200121 -id 0 -s "226,226" -g
```

#### 引数一覧
| 引数 | 値の型 | デフォルト値 | 概要 |
| :---: | :----: | :----- | :--- |
| -n | str |  | データセットの名前を指定してください。testimages フォルダ内に test/Ok などを含んだデータセット用フォルダを作成します。 |
| -id | int | 0 | 使用するカメラの ID を指定します。端末にカメラ機器が1台しか繋がっていない場合は 0 ですが、複数台接続されている場合は 1 や 2 などにもなり得ます。 |
| -s | tuple | "192,192" | 保存する画像のサイズを指定します。ビューファインダーの解像度も同じになります。 |
| -g | - |  | カメラのプレビュー画面で中心線などのガイドを利用できます。写真解像度が960*720の時に限り機能します。 |
| -m | - |  | カメラのプレビュー画面で画像を左右反転して表示します。 |

#### プレビュー画面上のキーボード操作方法
| キー | 実行内容 |
|:----:|:---------|
| `ESC` | このプログラムを終了します。 |
| `a` | 「学習用の良品画像」を撮影し、`train/OK` フォルダ内に保存します。 |
| `s` | 「評価用の良品画像」を撮影し、`test/OK` フォルダ内に保存します。 |
| `d` | 「評価用の不良品画像」を撮影し、`test/NG` フォルダ内に保存します。 |

## 2. 学習する

さきほど学習したデータセットを学習し、最後の推論(検品)に使うための「重みデータ」ファイルを作成します。  
ここではカメラは必要なく、コマンドの実行だけで学習を行うことができます。

次のコマンドをターミナル上で実行することで、データセット内の画像がトリミングされ、学習が開始されます。  
学習が完了すると、重みデータのファイルが `learned_weight` フォルダ内に保存されます。  
最後に生成された重みデータに対して性能評価が実行され、「学習用の良品画像」、「評価用の良品画像」、「評価用の不良品画像」それぞれの分布を示すヒストグラム画面が表示されます。

そのヒストグラム画面を参考に、次に行う推論(検品)で指定する「閾値」の参考にしてください。

### 学習用スクリプト `sample_optimization.py` の使用方法

#### コマンド実行方法

ターミナル上で、次のようなコマンドを実行して指定したデータセットを学習させてください。  
コマンドの引数について詳しくは、下図「引数一覧」を参照してください。

```sh
$ python sample_optimization.py -s -c -tr -n MobileNet -d lof -l 86 -p testimages/aluminum_cubic_20200121
```

#### 引数一覧
| 引数 | 値の型 | デフォルト値 | 概要 |
| :---: | :----: | :----- | :--- |
| -n | str | MobileNet | 使用する特徴抽出器のコード名(※1)を指定します。 |
| -d | str | lof | 使用する分類器のコード名(※2)を指定します。 |
| -p | str | testimages/aluminum_cubic_20200121 | データセットの場所を指定します。test/NG, test/OK, train/OK ディレクトリが含まれている必要があります。 |
| -s | - | - | ヒストグラムを最後に画面で表示する代わりに、画像として保存してプログラムを終了します。ヒストグラム画像は、`learned_weight` フォルダ内に作成される重みデータ `.joblib` ファイルと同じ場所に同名で保存されます。 |
| -tr | - | - | トリミングを実施します。 |
| -c | - | - | トリミング範囲の中心を画像の中心に合わせます |
| -ap | tuple | "226,226" | トリミング範囲の左上点を座標指定します。 |
| -ts | tuple | "226,226" | トリミング範囲の大きさを(w, h)で指定します。 |

## 3. 推論する (検品)

ここまでの作業で、推論(検品)を行う準備が整いましたので、ここからは実際に学習データを用いて推論の作業を行います。

さきほど作成された重みファイルを `learned_weight` フォルダ内で確認し、次のコマンド内の「-jl」引数で重みファイルのパスを指定してください。

### 推論用スクリプト `sample_inspection.py` の使用方法

#### コマンド実行方法

ターミナル上で、次のようなコマンドを実行してスタンドアロンで推論を開始します。
コマンドの引数について詳しくは、下図「引数一覧」を参照してください。

```sh
$ python sample_inspection.py -c -t -0.3 -cam -n MobileNet -d lof -l 86 -jl learned_weight/aluminum_cubic_****.joblib
```
                                     
#### 引数一覧
| 引数 | 値の型 | デフォルト値 | 概要 |
| :---: | :----: | :----- | :--- |
| -i2c_input | - |  | I2C 通信からのトリガ信号で推論作業を実行する場合はこのモードを有効にしてください。この引数がない場合は、ターミナルからこのスクリプトを実行することで、手動で推論作業を行うことができるようになります。 |
| -i2c_output | - |  | 推論結果を I2C 通信で送信する場合はこのモードを有効にしてください。この引数がない場合は、出力結果は I2C 通信では出力されません |
| -n | str | MobileNet | 使用する特徴抽出器のコード名(※1)を指定します。 |
| -d | str | lof | 使用する分類器のコード名(※2)を指定します。 |
| -jl | str | learned_weight/sample.joblib | 学習用スクリプト `sample_optimization.py` によって作成された学習済み重みファイル (.joblib ファイル) のパスを指定します。 |
| -t | float | -0.5 | 良品か不良品かを判定する際の閾値 (境となるスコア値) を指定します。 |
| -l | int | 18 | 何番目のレイヤー層を使用するかを指定します。 |
| -tr | - |  | 画像のトリミングを実施します。 |
| -c | - |  | トリミング範囲の中心を画像の中心に合わせます。 |
| -ap | tuple | "0,0" | トリミング範囲の左上点を座標指定します。 |
| -ts | tuple | "226,226" | トリミング範囲の大きさを(w,h)で指定します。 |
| -cam | - |  | カメラを使用して画像を取得します。 |
| -ci | int | 0 | 使用するカメラの ID を指定します。端末にカメラ機器が1台しか繋がっていない場合は 0 ですが、複数台接続されている場合は 1 や 2 などにもなり得ます。 |
| -s | tuple | "226,226" | カメラから取得する画像の大きさを(w,h)で指定します。  |
| -g | - |  | カメラのプレビュー画面でガイドを表示します。 |
| -m | - |  | カメラのプレビュー画面で画像を左右反転して表示します。 |

#### 注意事項
- 学習用スクリプトと推論用スクリプトでは、双方同一の `特徴抽出器(-n)`、`分類器(-d)`、`レイヤー層(-l)` を使用する必要があります。

#### ※1 利用可能な「特徴抽出器」一覧
| 正式名称 | コード名 | Raspberry Pi 対応 | 特徴 |
| :------: | :--------: | :---------------: | :--- |
| MobileNet V1 | MobileNet | ✔ | 対応している画像サイズは、224, 192, 160, 128 (px) のいずれかの大きさの正方形である必要があります。 |
| MobileNet V2 | MobileNetV2 | ✔ |  |
| Xception | Xception | ✖ |  |
| Inception V3 | InceptionV3 | ✖ |  |
| Inception ResNet V2 | InceptionResNetV2 | ✖ |  |
| DenseNet | DenseNet | ✖ |  |
| NASNet | NASNet | ✖ |  |
| VGG16 | vgg | ✖ |  |
| ResNet50 | ResNet | ✖ |  |

#### ※2 利用可能な「分類器」一覧
| 正式名称 | コード名 | Raspberry Pi 対応 | 特徴 |
| :------: | :--------: | :---------------: | :--- |
| Local Outlier Factor | lof | ✔ | データ点の密集度の違いで異常検知。疎なところが異常 |
| Robust Covariance | robustcovariance | ✖ | 共分散を推定し，それを元にデータが正常である確率分布を推定する。最後に，・確率が閾値以下のデータを異常判定 |
| Angle Based Outlier Detection | abod | ✔ | 近傍の点となす角度を元に異常検知 |
| Isolation Forest | iforest | ✔ | 「決定木」（樹形図のようなもの）を用いて異常度を算出 |
| Median K Nearest Neighbors | knn | ✔ | xが既にある正常データと近ければ正常，遠ければ異常。閾値判定。 |

---
---
---
---
---

## 演習問題

### 1. 閾値
設定する閾値は次のうちどれが最もよいか、AとBそれぞれの場合について、理由も含めて答えよ。

A. 不良品の見逃しを防ぎたい場合
B. 良品の誤検出を防ぎたい場合

1. 不良品スコアの最小値
2. 不良品スコアの最大値
3. 不良品スコアの最大値と良品スコアの最小値のうち小さい方
4. 不良品スコアの最大値と良品スコアの最小値の平均
5. 不良品スコアの最大値と良品スコアの最小値のうち大きい方
6. 良品スコアの最小値
7. 良品スコアの最大値

### 2. 特徴量抽出器
適切に学習された特徴量抽出器の入力と出力(特徴量)とはどのようなものか、次の中から選べ。

1. 対象を撮影した画像
2. 対象を置く前の背景を撮影した画像
3. 対象の音声データ
4. 対象の特徴を抽出したベクトルデータ
5. 対象が正常か異常かを表す二値データ(0または1)

### 3. 分類器
分類器の種類を以下のものに変えることで、良品と不良品のスコアはどのように変化するか。

- LOF
- ABOD
- IFOREST
- KNN

### 4. サイズ
A. 異常部分(傷)を大きくすると, 不良品のスコアはどのように変化するか。
B. 画像サイズをクロップして小さくしてから学習させると、不良品のスコアはどのように変化するか。

※注意: リサイズとクロップは異なる処理である.
- リサイズ: 画像全体を拡大・縮小してサイズを変更すること
- クロップ: 画像の一部分を切り抜くこと

### 5. レイヤー層
MobileNet の特徴量抽出層をそれぞれ 18、50、95 層としたとき、良品と不良品のスコアはどのように変化するか。

### 6. まとめ
上記を踏まえ、この異常検知装置の特徴と使い方をまとめよ。
また、他のどのような検査に応用できそうかあなたの考えを述べよ。


## 解答
### 1. 閾値
- A. 不良品の見逃しを防ぎたい場合: 5
- B. 良品の誤検出を防ぎたい場合: 3

参考: 不良品の見逃しと良品の誤検出をどちらもある程度に抑えたい場合は4。

### 2. 特徴量抽出器
- 入力: 1
- 出力(特徴量): 4

5は分類器の出力であり、特徴量の説明ではない。

### 3. 分類器
(検証予定)

### 4. サイズ
- A. 小さくなる
- B. 小さくなる

画像全体に対する異常部分の割合が大きくなるほど不良品のスコアは小さくなる。

### 5. レイヤー層
18、50、95 層の順に、良品と不良品のスコアが離れていく。

### 6. まとめ (回答例)
この装置は対象画像の特徴を適切に抽出し, その特徴をもとに良品を良品として分類できるよう学習するディープラーニングを用いた異常検知アルゴリズムである. 同じ特徴をもった製品を大量生産する際にこの装置は効果を発するので, 工場の精密機械や加工食品の成形の検査などに応用できると考えられる.

